<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הגדרת מערכת הגנה מצינטוקים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        input, textarea { border: 1px solid #e2e8f0; transition: all 0.2s; }
        input:focus, textarea:focus { border-color: #3b82f6; ring: 2px; ring-color: #bfdbfe; outline: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4">

    <div class="max-w-xl mx-auto card p-8 mt-10">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-slate-800">מגן צינתוקים IVR</h1>
            <p class="text-slate-500 mt-2">הגדרת רשימה לבנה חכמה למערכת ימות המשיח</p>
        </header>
        
        <!-- פרטי התחברות -->
        <section class="space-y-4 mb-8">
            <div class="flex items-center gap-2 mb-2 text-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <h2 class="font-bold">פרטי התחברות למערכת</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="systemNumber" placeholder="מספר מערכת" class="p-3 rounded-lg bg-slate-50 w-full">
                <input type="password" id="systemPassword" placeholder="סיסמה" class="p-3 rounded-lg bg-slate-50 w-full">
            </div>
        </section>

        <!-- הגדרות יעד -->
        <section class="space-y-4 mb-8">
            <div class="flex items-center gap-2 mb-2 text-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.209.388l-2.235 2.235a13.503 13.503 0 01-5.482-5.482l2.235-2.235a1 1 0 00.388-1.209L10.28 4.684A1 1 0 009.332 4H5z" />
                </svg>
                <h2 class="font-bold">הגדרות ניתוב</h2>
            </div>
            <input type="text" id="targetNumber" placeholder="המספר אליו יופנו השיחות (הנייד שלך)" class="p-3 rounded-lg bg-slate-50 w-full">
        </section>

        <!-- רשימה לבנה ידנית -->
        <section class="space-y-4 mb-8">
            <div class="flex items-center gap-2 mb-2 text-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <h2 class="font-bold">מספרים מאושרים מראש (אופציונלי)</h2>
            </div>
            <textarea id="manualWhiteList" rows="3" placeholder="הכנס מספרים (אחד בכל שורה)" class="p-3 rounded-lg bg-slate-50 w-full text-left font-mono"></textarea>
        </section>

        <!-- העלאת הודעה -->
        <section class="space-y-4 mb-8">
            <div class="flex items-center gap-2 mb-2 text-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
                <h2 class="font-bold">הודעת הסבר (לשלוחה 200)</h2>
            </div>
            <input type="file" id="audioFile" accept="audio/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
        </section>

        <button onclick="startSetup()" id="mainBtn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-colors">
            החל הגדרות במערכת
        </button>

        <div id="status" class="mt-6 text-center text-sm hidden"></div>
    </div>

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden flex-col items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p id="loaderStatus" class="font-bold text-slate-700">מעדכן נתונים...</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://www.call2all.co.il/ym/api/';

        async function callApi(method, params) {
            const fd = new FormData();
            for (const k in params) fd.append(k, params[k]);
            const res = await fetch(`${API_URL}${method}`, { method: 'POST', body: fd });
            return await res.json();
        }

        async function startSetup() {
            const sn = document.getElementById('systemNumber').value;
            const sp = document.getElementById('systemPassword').value;
            const tn = document.getElementById('targetNumber').value;
            const mwl = document.getElementById('manualWhiteList').value;
            const audio = document.getElementById('audioFile').files[0];

            if(!sn || !sp || !tn) return alert("נא למלא פרטי מערכת ומספר יעד");

            const loader = document.getElementById('loader');
            const status = document.getElementById('status');
            const lStatus = document.getElementById('loaderStatus');

            loader.classList.remove('hidden');
            loader.classList.add('flex');
            status.classList.add('hidden');

            try {
                // 1. התחברות
                lStatus.innerText = "מתחבר...";
                const auth = await callApi('Login', { username: sn, password: sp });
                if(auth.responseStatus !== 'OK') throw new Error("שגיאת התחברות");
                const token = auth.token;

                // 2. שלוחה ראשית
                lStatus.innerText = "מגדיר שלוחה ראשית...";
                const configMain = [
                    'type=nitoviya',
                    `nitoviya_dial_to=${tn}`,
                    'white_list=yes',
                    'white_list_by_key=yes',
                    'white_list_By_key_not_found_by_value=yes',
                    'white_list_error_goto=/200',
                    'say_m1102=no'
                ].join('\n');
                await callApi('UpdateExtensionConfig', { token, path: '', config: configMain });

                // 3. שלוחה 200
                lStatus.innerText = "מגדיר תפריט אישור...";
                await callApi('UpdateExtensionConfig', { token, path: '200', config: 'type=menu' });

                // 4. שלוחה 200/1 - הוספה לרשימה הלבנה
                lStatus.innerText = "מגדיר שלוחת הוספה...";
                const configAdd = [
                    'type=add_id_to_list',
                    'title=הוספה לרשימה לבנה',
                    'add_id_to_list_location_list=WhiteList', // שים לב לשינוי לשם הקובץ ישירות
                    'add_id_to_list_value=yes',
                    'add_id_to_list_value_change=yes',
                    'add_id_to_list_end_goto=/',
                    'add_id_to_list_error_end_goto=hangup'
                ].join('\n');
                await callApi('UpdateExtensionConfig', { token, path: '200/1', config: configAdd });

                // 5. טיפול ברשימה לבנה ידנית (WhiteList.ini)
                if(mwl.trim()) {
                    lStatus.innerText = "מעדכן רשימה לבנה ידנית...";
                    // מנסים להוריד את הקובץ הקיים כדי לא לדרוס
                    const existing = await callApi('DownloadFile', { token, path: 'WhiteList.ini' });
                    let currentContent = "";
                    if(existing && typeof existing === 'string') currentContent = existing;
                    
                    const newNumbers = mwl.split('\n').map(s => s.trim()).filter(s => s).join('\n');
                    const finalContent = currentContent ? (currentContent + '\n' + newNumbers) : newNumbers;

                    await callApi('UploadTextFile', {
                        token,
                        path: '',
                        fileName: 'WhiteList.ini',
                        contents: finalContent
                    });
                }

                // 6. העלאת שמע
                if(audio) {
                    lStatus.innerText = "מעלה הודעת הסבר...";
                    await callApi('UploadFile', { token, path: '200', file: audio });
                }

                status.innerText = "ההגדרה הסתיימה בהצלחה!";
                status.className = "mt-6 text-center text-green-600 font-bold block";

            } catch(e) {
                status.innerText = "שגיאה: " + e.message;
                status.className = "mt-6 text-center text-red-600 font-bold block";
            } finally {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }
    </script>
</body>
</html>
