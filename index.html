<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מגן צינתוקים - תיקון Invalid WS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; }
        .console { background: #000; color: #0f0; font-family: monospace; padding: 10px; border-radius: 8px; height: 250px; overflow-y: auto; font-size: 11px; }
        .input-group { margin-bottom: 1rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.3rem; font-size: 0.9rem; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4">

<div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg border border-gray-300">
    <h1 class="text-xl font-bold text-center mb-6 text-blue-800">הגדרת מערכת IVR נגד צינתוקים</h1>

    <div id="loginStep">
        <div class="input-group">
            <label>מספר מערכת</label>
            <input type="text" id="user" class="w-full p-2 border rounded" placeholder="079...">
        </div>
        <div class="input-group">
            <label>סיסמה</label>
            <input type="password" id="pass" class="w-full p-2 border rounded">
        </div>
        <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">התחבר</button>
    </div>

    <div id="mfaStep" class="hidden">
        <div class="input-group text-center">
            <label class="text-orange-600">הזן קוד אימות MFA שקיבלת</label>
            <input type="text" id="mfaCode" class="w-full p-2 border rounded text-center text-xl font-bold tracking-widest">
        </div>
        <button onclick="verifyMfa()" class="w-full bg-orange-500 text-white p-3 rounded font-bold hover:bg-orange-600">אמת קוד</button>
    </div>

    <div id="configStep" class="hidden">
        <div class="input-group">
            <label>מספר היעד שלך (נייד)</label>
            <input type="text" id="target" class="w-full p-2 border rounded" placeholder="050...">
        </div>
        <div class="input-group">
            <label>הודעת שמע (200/M0000.wav)</label>
            <input type="file" id="audio" class="w-full p-2 border border-dashed rounded text-sm">
        </div>
        <div class="input-group">
            <label>מספרים לאישור ידני (בשורות נפרדות)</label>
            <textarea id="manual" class="w-full p-2 border rounded" rows="3"></textarea>
        </div>
        <button onclick="runSetup()" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700">החל הגדרות במערכת</button>
    </div>

    <div class="mt-6">
        <label>לוג פעולות:</label>
        <div id="log" class="console"></div>
    </div>
</div>

<script>
    const API_URL = 'https://www.call2all.co.il/ym/api/';
    let token = '';

    function printLog(text, isErr = false) {
        const l = document.getElementById('log');
        const div = document.createElement('div');
        if(isErr) div.style.color = '#ff4d4d';
        div.innerText = `[${new Date().toLocaleTimeString()}] ${text}`;
        l.appendChild(div);
        l.scrollTop = l.scrollHeight;
        console.log(text);
    }

    async function req(method, params) {
        printLog(`קריאה ל: ${method}`);
        const fd = new FormData();
        for(const k in params) fd.append(k, params[k]);
        
        try {
            const r = await fetch(`${API_URL}${method}`, { method: 'POST', body: fd });
            const data = await r.json();
            printLog(`תגובה (${method}): ${JSON.stringify(data)}`);
            return data;
        } catch(e) {
            printLog(`שגיאת רשת ב-${method}: ${e.message}`, true);
            return { responseStatus: 'ERROR' };
        }
    }

    async function login() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const res = await req('Login', { username: u, password: p });
        if(res.responseStatus === 'OK') {
            token = res.token;
            if(res.mfa_static_token_required) {
                printLog("נדרש MFA...");
                await req('MFASession', { token, action: 'sendMFA' });
                document.getElementById('loginStep').classList.add('hidden');
                document.getElementById('mfaStep').classList.remove('hidden');
            } else {
                document.getElementById('loginStep').classList.add('hidden');
                document.getElementById('configStep').classList.remove('hidden');
            }
        } else {
            alert("שגיאת התחברות: " + res.message);
        }
    }

    async function verifyMfa() {
        const code = document.getElementById('mfaCode').value;
        const res = await req('MFASession', { token, action: 'validMFA', mfaCode: code });
        if(res.mfa_valid_status === 'VALID') {
            printLog("MFA הצליח!");
            document.getElementById('mfaStep').classList.add('hidden');
            document.getElementById('configStep').classList.remove('hidden');
        } else {
            alert("קוד שגוי");
        }
    }

    // פונקציית עזר לעדכון קובץ ext.ini - זה פותר את בעיית ה-Invalid WS
    async function updateExtIni(path, configStr) {
        printLog(`מעדכן ext.ini בנתיב: /${path}`);
        return await req('UploadTextFile', {
            token: token,
            path: path,
            fileName: 'ext.ini',
            contents: configStr
        });
    }

    async function runSetup() {
        const targetNum = document.getElementById('target').value;
        const manualList = document.getElementById('manual').value;
        const audioFile = document.getElementById('audio').files[0];

        if(!targetNum) return alert("הזן מספר יעד");

        // שלב 1: שלוחה ראשית
        const mainIni = [
            'type=nitoviya',
            `nitoviya_dial_to=${targetNum}`,
            'white_list=yes',
            'white_list_by_key=yes',
            'white_list_By_key_not_found_by_value=yes',
            'white_list_error_goto=/200',
            'say_m1102=no'
        ].join('\n');
        await updateExtIni('', mainIni);

        // שלב 2: שלוחה 200
        await updateExtIni('200', 'type=menu');

        // שלב 3: שלוחה 200/1 - חשוב להשתמש בנתיב אב לקובץ הלבן
        const addIni = [
            'type=add_id_to_list',
            'title=הוספה לרשימה לבנה',
            'add_id_to_list_location_list=../WhiteList.ini', // מפנה רמה אחת למעלה
            'add_id_to_list_value=yes',
            'add_id_to_list_value_change=yes',
            'add_id_to_list_end_goto=/',
            'add_id_to_list_error_end_goto=hangup'
        ].join('\n');
        await updateExtIni('200/1', addIni);

        // שלב 4: WhiteList.ini ידני
        if(manualList.trim()) {
            printLog("מעדכן רשימה ידנית...");
            const oldFile = await req('DownloadFile', { token, path: 'WhiteList.ini' });
            let content = (typeof oldFile === 'string' && !oldFile.includes('{')) ? oldFile : "";
            const cleanNew = manualList.split('\n').map(s => s.trim()).filter(s => s).join('\n');
            const final = content ? (content + '\n' + cleanNew) : cleanNew;
            
            await req('UploadTextFile', {
                token,
                path: '',
                fileName: 'WhiteList.ini',
                contents: final
            });
        }

        // שלב 5: העלאת שמע
        if(audioFile) {
            printLog("מעלה קובץ שמע...");
            await req('UploadFile', { token, path: '200', file: audioFile });
        }

        printLog("התהליך הסתיים בהצלחה!");
        alert("הגדרות המערכת עודכנו.");
    }
</script>
</body>
</html>
