<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מגן צינתוקים - גרסה מתוקנת סופית</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; background: #f9fafb; }
        .log-box { background: #1a202c; color: #48bb78; font-family: monospace; font-size: 12px; }
        .step { display: none; }
        .step.active { display: block; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-xl mx-auto bg-white rounded-xl shadow-2xl p-6 border border-gray-200">
        <h1 class="text-2xl font-bold text-center text-blue-700 mb-6">מערכת הגדרת הגנה מצינתוקים</h1>

        <!-- שלב 1: התחברות -->
        <div id="step1" class="step active space-y-4">
            <h2 class="font-bold border-b pb-2">התחברות למערכת</h2>
            <input type="text" id="sysUser" placeholder="מספר מערכת" class="w-full p-3 border rounded">
            <input type="password" id="sysPass" placeholder="סיסמה" class="w-full p-3 border rounded">
            <button onclick="doLogin()" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">התחבר ושלח קוד MFA</button>
        </div>

        <!-- שלב 2: אימות MFA -->
        <div id="stepMfa" class="step space-y-4">
            <h2 class="font-bold text-orange-600 border-b pb-2">אימות קוד (MFA)</h2>
            <p class="text-sm">הזן את הקוד שקיבלת בטלפון/מייל:</p>
            <input type="text" id="mfaCode" placeholder="קוד אימות" class="w-full p-3 border rounded text-center text-xl tracking-widest">
            <button onclick="doVerifyMfa()" class="w-full bg-orange-500 text-white p-3 rounded font-bold">אמת קוד והמשך</button>
        </div>

        <!-- שלב 3: הגדרות -->
        <div id="stepConfig" class="step space-y-4">
            <h2 class="font-bold text-green-600 border-b pb-2">הגדרות ניתוב</h2>
            <input type="text" id="targetNum" placeholder="המספר אליו יועברו השיחות" class="w-full p-3 border rounded">
            
            <label class="block text-xs font-bold mt-2">הוספה ידנית ל-WhiteList.ini (מספר בכל שורה):</label>
            <textarea id="manualEntries" rows="3" class="w-full p-3 border rounded text-sm"></textarea>

            <label class="block text-xs font-bold mt-2">הודעת שמע לשלוחה 200 (M0000):</label>
            <input type="file" id="audioFile" accept="audio/*" class="w-full p-2 border border-dashed rounded text-xs">

            <button onclick="doApply()" class="w-full bg-green-600 text-white p-4 rounded-lg font-bold shadow-lg hover:bg-green-700">בצע הגדרות עכשיו</button>
        </div>

        <!-- קונסול הודעות -->
        <div id="console" class="mt-8 p-4 log-box rounded-lg h-48 overflow-y-auto">
            > המערכת מוכנה לפעולה.
        </div>
    </div>

    <script>
        const API = 'https://www.call2all.co.il/ym/api/';
        let token = '';

        function writeLog(msg, error = false) {
            const box = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = error ? 'text-red-400' : '';
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            box.appendChild(entry);
            box.scrollTop = box.scrollHeight;
            console.log(msg);
        }

        async function call(method, params) {
            writeLog(`מבצע פנייה ל-${method}...`);
            const fd = new FormData();
            for (const k in params) fd.append(k, params[k]);

            try {
                const r = await fetch(`${API}${method}`, { method: 'POST', body: fd });
                const res = await r.json();
                writeLog(`תגובת שרת (${method}): ${JSON.stringify(res)}`);
                return res;
            } catch (e) {
                writeLog(`שגיאה בקריאה ל-${method}: ${e.message}`, true);
                return { responseStatus: 'EXCEPTION' };
            }
        }

        async function doLogin() {
            const u = document.getElementById('sysUser').value;
            const p = document.getElementById('sysPass').value;
            const res = await call('Login', { username: u, password: p });
            
            if (res.responseStatus === 'OK') {
                token = res.token;
                if (res.mfa_static_token_required) {
                    writeLog("נדרש MFA. שולח קוד...");
                    await call('MFASession', { token, action: 'sendMFA' });
                    changeStep('stepMfa');
                } else {
                    changeStep('stepConfig');
                }
            } else {
                alert("התחברות נכשלה: " + res.message);
            }
        }

        async function doVerifyMfa() {
            const code = document.getElementById('mfaCode').value;
            const res = await call('MFASession', { token, action: 'validMFA', mfaCode: code });
            if (res.mfa_valid_status === 'VALID') {
                writeLog("אימות MFA הצליח!");
                changeStep('stepConfig');
            } else {
                alert("קוד שגוי");
            }
        }

        async function doApply() {
            const target = document.getElementById('targetNum').value;
            const manual = document.getElementById('manualEntries').value;
            const audio = document.getElementById('audioFile').files[0];

            if(!target) return alert("אנא הזן מספר יעד");

            try {
                // 1. שלוחה ראשית - הגדרות חובה
                writeLog("מעדכן שלוחה ראשית...");
                const mainConfig = [
                    'type=nitoviya',
                    `nitoviya_dial_to=${target}`,
                    'white_list=yes',
                    'white_list_by_key=yes',
                    'white_list_By_key_not_found_by_value=yes',
                    'white_list_error_goto=/200',
                    'say_m1102=no'
                ].join('\n');
                
                // שימוש ב-override=yes כדי לוודא דריסה
                await call('UpdateExtensionConfig', { token, path: '', config: mainConfig, override: 'yes' });

                // 2. שלוחה 200
                writeLog("מעדכן שלוחה 200...");
                await call('UpdateExtensionConfig', { token, path: '200', config: 'type=menu', override: 'yes' });

                // 3. שלוחה 200/1
                writeLog("מעדכן שלוחה 200/1...");
                const addCfg = [
                    'type=add_id_to_list',
                    'title=הוספה לרשימה לבנה',
                    'add_id_to_list_location_list=WhiteList.ini',
                    'add_id_to_list_value=yes',
                    'add_id_to_list_value_change=yes',
                    'add_id_to_list_end_goto=/',
                    'add_id_to_list_error_end_goto=hangup'
                ].join('\n');
                await call('UpdateExtensionConfig', { token, path: '200/1', config: addCfg, override: 'yes' });

                // 4. WhiteList.ini
                if(manual.trim()) {
                    writeLog("מעדכן WhiteList.ini...");
                    // ניסיון להוריד קובץ קיים (בפורמט טקסט)
                    const old = await call('DownloadFile', { token, path: 'WhiteList.ini' });
                    let content = (typeof old === 'string') ? old : "";
                    const cleanedManual = manual.split('\n').map(s => s.trim()).filter(s => s).join('\n');
                    const updatedContent = content ? (content + '\n' + cleanedManual) : cleanedManual;
                    
                    await call('UploadTextFile', {
                        token,
                        path: '',
                        fileName: 'WhiteList.ini',
                        contents: updatedContent
                    });
                }

                // 5. קובץ שמע
                if(audio) {
                    writeLog("מעלה קובץ שמע לשלוחה 200...");
                    await call('UploadFile', { token, path: '200', file: audio });
                }

                writeLog("מבצע רענון מערכת סופי...");
                // פקודה אופציונלית לרענון - בדרך כלל לא חובה ב-API אבל עוזרת לוודא כתיבה
                await call('GetExtensionConfig', { token, path: '' }); 

                writeLog("התהליך הסתיים!");
                alert("ההגדרות הוחלו בהצלחה במערכת!");

            } catch (e) {
                writeLog("שגיאה קריטית: " + e.message, true);
            }
        }

        function changeStep(id) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
