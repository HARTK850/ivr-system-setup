<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××’×Ÿ ×¦×™× ×ª×•×§×™× - ×ª×™×§×•×Ÿ ××œ×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; }
        .console { background: #000; color: #0f0; font-family: monospace; padding: 12px; border-radius: 8px; height: 320px; overflow-y: auto; font-size: 12px; }
        .input-group { margin-bottom: 1.3rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.4rem; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4">
<div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg border border-gray-300">
    <h1 class="text-2xl font-bold text-center mb-8 text-blue-800">××’×Ÿ ×¦×™× ×ª×•×§×™× - ×”×’×“×¨×” ××œ××”</h1>
    
    <div id="loginStep">
        <div class="input-group">
            <label>××¡×¤×¨ ××¢×¨×›×ª</label>
            <input type="text" id="user" class="w-full p-3 border rounded-lg" placeholder="079...">
        </div>
        <div class="input-group">
            <label>×¡×™×¡××”</label>
            <input type="password" id="pass" class="w-full p-3 border rounded-lg">
        </div>
        <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold">×”×ª×—×‘×¨</button>
    </div>

    <div id="mfaStep" class="hidden">
        <div class="input-group text-center">
            <label class="text-orange-600 block mb-2">×§×•×“ MFA</label>
            <input type="text" id="mfaCode" class="w-full p-4 border-2 border-orange-400 rounded-xl text-center text-3xl tracking-widest font-mono">
        </div>
        <button onclick="verifyMfa()" class="w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg font-bold">×××ª ×§×•×“</button>
    </div>

    <div id="configStep" class="hidden">
        <div class="input-group">
            <label>××¡×¤×¨ ×™×¢×“ (× ×™×™×“)</label>
            <input type="text" id="target" class="w-full p-3 border rounded-lg" placeholder="0501234567">
        </div>
        <div class="input-group">
            <label>×§×•×‘×¥ ×©××¢ (×œ×©×œ×•×—×” 200)</label>
            <input type="file" id="audio" class="w-full p-2 border border-dashed rounded-lg">
        </div>
        <div class="input-group">
            <label>××¡×¤×¨×™× ×œ××™×©×•×¨ ×™×“× ×™ (×©×•×¨×” ×œ×›×œ ××¡×¤×¨)</label>
            <textarea id="manual" class="w-full p-3 border rounded-lg h-28" placeholder="0501111111&#10;0522222222"></textarea>
        </div>
        <button onclick="runSetup()" class="w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg font-bold text-lg">ğŸš€ ×¦×•×¨ ×©×œ×•×—×•×ª + WhiteList</button>
    </div>

    <div class="mt-8">
        <label class="block mb-2 font-bold">×œ×•×’ ×¤×¢×•×œ×•×ª (×‘×“×•×§ ×›××Ÿ):</label>
        <div id="log" class="console"></div>
    </div>
</div>

<script>
    const API_URL = 'https://www.call2all.co.il/ym/api/';
    let token = '';

    function printLog(text, isErr = false) {
        const l = document.getElementById('log');
        const div = document.createElement('div');
        if (isErr) div.style.color = '#ff4d4d';
        div.innerText = `[${new Date().toLocaleTimeString('he-IL')}] ${text}`;
        l.appendChild(div);
        l.scrollTop = l.scrollHeight;
    }

    async function req(method, params) {
        printLog(`â†’ ${method}`);
        const fd = new FormData();
        for (const k in params) fd.append(k, params[k]);
        try {
            const r = await fetch(API_URL + method, { method: 'POST', body: fd });
            const data = await r.json();
            printLog(`â† ${method}: ${data.responseStatus || 'ERROR'}`);
            if (data.responseStatus !== 'OK') printLog(`×©×’×™××”: ${data.message || data.exceptionMessage || JSON.stringify(data)}`, true);
            return data;
        } catch (e) {
            printLog(`×©×’×™××ª ×¨×©×ª: ${e.message}`, true);
            return { responseStatus: 'ERROR' };
        }
    }

    async function login() {
        const u = document.getElementById('user').value.trim();
        const p = document.getElementById('pass').value;
        const res = await req('Login', { username: u, password: p });
        if (res.responseStatus === 'OK') {
            token = res.token;
            document.getElementById('loginStep').classList.add('hidden');
            if (res.mfa_static_token_required) {
                printLog("× ×“×¨×© MFA");
                document.getElementById('mfaStep').classList.remove('hidden');
            } else {
                document.getElementById('configStep').classList.remove('hidden');
            }
        } else alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª");
    }

    async function verifyMfa() {
        const code = document.getElementById('mfaCode').value.trim();
        const res = await req('MFASession', { token, action: 'validMFA', mfaCode: code });
        if (res.mfa_valid_status === 'VALID') {
            printLog("âœ… MFA ×”×¦×œ×™×—!");
            document.getElementById('mfaStep').classList.add('hidden');
            document.getElementById('configStep').classList.remove('hidden');
        } else alert("×§×•×“ ×©×’×•×™");
    }

    // ====================== UpdateExtension - ×™×•×¦×¨ ×©×œ×•×—×•×ª =================
    async function updateExtension(extPath, settings) {
        printLog(`×™×•×¦×¨/××¢×“×›×Ÿ ×©×œ×•×—×”: ${extPath}`);
        const params = { token, path: `ivr2:${extPath}` };
        for (const key in settings) params[key] = settings[key];
        return await req('UpdateExtension', params);
    }

    async function runSetup() {
        const targetNum = document.getElementById('target').value.trim();
        const manualList = document.getElementById('manual').value.trim();
        const audioFile = document.getElementById('audio').files[0];

        if (!targetNum) return alert("×—×¡×¨ ××¡×¤×¨ ×™×¢×“!");

        // 1. ×©×œ×•×—×” ×¨××©×™×ª - × ×™×˜×•×‘×™×”
        await updateExtension('', {
            type: 'nitoviya',
            nitoviya_dial_to: targetNum,
            white_list: 'yes',
            white_list_by_key: 'yes',
            white_list_By_key_not_found_by_value: 'yes',
            white_list_error_goto: '/200',
            say_m1102: 'no'
        });

        // 2. ×©×œ×•×—×” 200 - ×ª×¤×¨×™×˜
        await updateExtension('200', { type: 'menu' });

        // 3. ×©×œ×•×—×” 200/1 - ×”×•×¡×¤×” ×œ×¨×©×™××” ×œ×‘× ×”
        await updateExtension('200/1', {
            type: 'add_id_to_list',
            title: '×”×•×¡×¤×” ×œ×¨×©×™××” ×œ×‘× ×”',
            add_id_to_list_location_list: '/WhiteList',
            add_id_to_list_value: 'yes',
            add_id_to_list_value_change: 'yes',
            add_id_to_list_end_goto: '/',
            add_id_to_list_error_end_goto: 'hangup'
        });

        // 4. WhiteList.ini ×‘×©×œ×•×—×” ×”×¨××©×™×ª
        if (manualList) {
            printLog("××¢×“×›×Ÿ WhiteList.ini");
            const dl = await req('GetTextFile', { token, what: 'ivr2:/WhiteList.ini' });
            let content = (dl.responseStatus === 'OK' && dl.contents) ? dl.contents : '';
            const newLines = manualList.split('\n').map(s => s.trim()).filter(Boolean).join('\n');
            const finalContent = content ? (content + '\n' + newLines) : newLines;

            await req('UploadTextFile', {
                token,
                what: 'ivr2:/WhiteList.ini',
                contents: finalContent
            });
        }

        // 5. ×”×¢×œ××ª ×©××¢ ×œ×©×œ×•×—×” 200
        if (audioFile) {
            printLog("××¢×œ×” ×©××¢ ×œ×©×œ×•×—×” 200");
            await req('UploadFile', { token, path: '200', file: audioFile });
        }

        printLog("âœ… ×”×›×œ × ×•×¦×¨ ×‘×”×¦×œ×—×”! ×©×œ×•×—×•×ª 200 + 200/1 + WhiteList.ini");
        alert("×”×›×œ ××•×›×Ÿ! ğŸ‰\n×¨×¢× ×Ÿ ××ª ×“×£ ×”× ×™×”×•×œ ×©×œ ×™××•×ª ×›×“×™ ×œ×¨××•×ª ××ª ×”×©×œ×•×—×•×ª.");
    }
</script>
</body>
</html>
