<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מגן צינתוקים - ניהול מתקדם</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f3f4f6; }
        .step-card { display: none; }
        .step-card.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-blue-600 p-6 text-white text-center">
            <h1 class="text-2xl font-bold">מערכת הגנה מצינתוקים</h1>
            <p class="opacity-80">חיבור מאובטח לימות המשיח (כולל MFA)</p>
        </div>

        <div class="p-6">
            <!-- שלב 1: התחברות ראשונית -->
            <div id="step1" class="step-card active space-y-4">
                <h2 class="text-lg font-bold border-b pb-2">שלב 1: התחברות</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="systemNumber" placeholder="מספר מערכת" class="p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-400">
                    <input type="password" id="systemPassword" placeholder="סיסמה" class="p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">התחבר ושלח קוד אימות</button>
            </div>

            <!-- שלב 2: אימות MFA -->
            <div id="stepMfa" class="step-card space-y-4">
                <h2 class="text-lg font-bold border-b pb-2 text-orange-600">שלב 2: אימות דו-שלבי</h2>
                <p class="text-sm text-gray-600">קוד אימות נשלח לבעל המערכת. אנא הזן אותו כאן:</p>
                <input type="text" id="mfaCode" placeholder="הזן קוד שקיבלת" class="w-full p-3 border rounded-lg text-center text-2xl tracking-widest outline-none focus:ring-2 focus:ring-orange-400">
                <button onclick="handleVerifyMfa()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition">אמת קוד והמשך להגדרות</button>
            </div>

            <!-- שלב 3: הגדרות IVR -->
            <div id="stepConfig" class="step-card space-y-6">
                <h2 class="text-lg font-bold border-b pb-2 text-green-600">שלב 3: הגדרות המערכת</h2>
                
                <div class="space-y-2">
                    <label class="block text-sm font-bold">מספר היעד שלך (להעברת שיחות):</label>
                    <input type="text" id="targetNumber" placeholder="לדוגמה: 0501234567" class="w-full p-3 border rounded-lg shadow-sm">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-bold">הודעת שמע לשלוחה 200 (M0000):</label>
                    <input type="file" id="audioFile" accept="audio/*" class="w-full text-sm">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-bold">מספרים להוספה ידנית ל-WhiteList.ini:</label>
                    <textarea id="manualList" rows="3" placeholder="מספר בכל שורה" class="w-full p-3 border rounded-lg font-mono text-sm"></textarea>
                </div>

                <button onclick="applySettings()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 shadow-lg transition">בצע הגדרות סופיות</button>
            </div>

            <div id="consoleLog" class="mt-6 p-4 bg-gray-900 text-green-400 font-mono text-xs rounded-lg h-32 overflow-y-auto">
                > המערכת מוכנה...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://www.call2all.co.il/ym/api/';
        let currentToken = '';

        function log(msg, isError = false) {
            const consoleBox = document.getElementById('consoleLog');
            const time = new Date().toLocaleTimeString();
            consoleBox.innerHTML += `<div class="${isError ? 'text-red-400' : ''}">[${time}] ${msg}</div>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
            console.log(`[IVR LOG] ${msg}`);
        }

        async function api(method, params) {
            log(`קריאה ל-${method}...`);
            const fd = new FormData();
            for (const key in params) fd.append(key, params[key]);
            
            try {
                const response = await fetch(`${API_BASE}${method}`, { method: 'POST', body: fd });
                const data = await response.json();
                log(`תגובה מ-${method}: ${data.responseStatus}`);
                return data;
            } catch (e) {
                log(`שגיאת רשת ב-${method}: ${e.message}`, true);
                throw e;
            }
        }

        async function handleLogin() {
            const user = document.getElementById('systemNumber').value;
            const pass = document.getElementById('systemPassword').value;

            try {
                const res = await api('Login', { username: user, password: pass });
                if (res.responseStatus === 'OK') {
                    currentToken = res.token;
                    log("התחברות ראשונית הצליחה. בודק צורך ב-MFA...");
                    
                    // בדיקת סטטוס MFA
                    if (res.mfa_static_token_required) {
                        log("נדרש אימות MFA. שולח קוד...");
                        await api('MFASession', { token: currentToken, action: 'sendMFA' });
                        showStep('stepMfa');
                    } else {
                        log("לא נדרש MFA, עובר ישירות להגדרות.");
                        showStep('stepConfig');
                    }
                } else {
                    throw new Error(res.message || "פרטים שגויים");
                }
            } catch (e) {
                alert(e.message);
            }
        }

        async function handleVerifyMfa() {
            const code = document.getElementById('mfaCode').value;
            try {
                const res = await api('MFASession', {
                    token: currentToken,
                    action: 'validMFA',
                    mfaCode: code
                });

                if (res.mfa_valid_status === 'VALID') {
                    log("אימות MFA הצליח!");
                    showStep('stepConfig');
                } else {
                    throw new Error("קוד שגוי או פג תוקף");
                }
            } catch (e) {
                alert(e.message);
            }
        }

        async function applySettings() {
            const target = document.getElementById('targetNumber').value;
            const manual = document.getElementById('manualList').value;
            const audio = document.getElementById('audioFile').files[0];

            if(!target) return alert("חובה להזין מספר יעד");

            try {
                // 1. הגדרת שלוחה ראשית
                log("מעדכן הגדרות שלוחה ראשית...");
                const mainCfg = `type=nitoviya\nnitoviya_dial_to=${target}\nwhite_list=yes\nwhite_list_by_key=yes\nwhite_list_By_key_not_found_by_value=yes\nwhite_list_error_goto=/200\nsay_m1102=no`;
                await api('UpdateExtensionConfig', { token: currentToken, path: '', config: mainCfg });

                // 2. הגדרת שלוחה 200
                log("מגדיר שלוחה 200...");
                await api('UpdateExtensionConfig', { token: currentToken, path: '200', config: 'type=menu' });

                // 3. הגדרת שלוחה 200/1 להוספה ל-WhiteList.ini
                log("מגדיר שלוחת הוספה (200/1)...");
                const addCfg = `type=add_id_to_list\ntitle=הוספה לרשימה לבנה\nadd_id_to_list_location_list=WhiteList.ini\nadd_id_to_list_value=yes\nadd_id_to_list_value_change=yes\nadd_id_to_list_end_goto=/\nadd_id_to_list_error_end_goto=hangup`;
                await api('UpdateExtensionConfig', { token: currentToken, path: '200/1', config: addCfg });

                // 4. עדכון WhiteList.ini ידני
                if (manual.trim()) {
                    log("מעדכן רשימה לבנה ידנית ב-WhiteList.ini...");
                    // מורידים קובץ קיים
                    const currentFile = await api('DownloadFile', { token: currentToken, path: 'WhiteList.ini' });
                    let content = (typeof currentFile === 'string') ? currentFile : "";
                    const newEntries = manual.split('\n').map(s => s.trim()).filter(s => s).join('\n');
                    const final = content ? (content + '\n' + newEntries) : newEntries;

                    await api('UploadTextFile', {
                        token: currentToken,
                        path: '',
                        fileName: 'WhiteList.ini',
                        contents: final
                    });
                }

                // 5. העלאת שמע
                if (audio) {
                    log("מעלה קובץ שמע לשלוחה 200...");
                    await api('UploadFile', { token: currentToken, path: '200', file: audio });
                }

                log("--- כל ההגדרות הושלמו בהצלחה! ---");
                alert("המערכת הוגדרה בהצלחה!");

            } catch (e) {
                log(`שגיאה בתהליך ההגדרה: ${e.message}`, true);
            }
        }

        function showStep(stepId) {
            document.querySelectorAll('.step-card').forEach(s => s.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
        }
    </script>
</body>
</html>
