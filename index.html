<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideGenius AI - מחולל מצגות אוטומטי</title>
    
    <!-- טעינת ספריות חיצוניות (CDNs) -->
    <!-- Tailwind CSS לעיצוב מהיר ורספונסיבי -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome לאייקונים -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PptxGenJS ליצירת קבצי PowerPoint -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
    <!-- Markdown It לרינדור טקסט עשיר -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- SortableJS לגרירה ושחרור -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* הגדרות CSS מותאמות אישית */
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f3f4f6;
            overflow-x: hidden;
        }

        /* גלילה מותאמת אישית */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        .slide-preview-card {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .slide-preview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .slide-preview-card.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .editor-area {
            min-height: 400px;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* התאמות לכיווניות */
        .rtl-input {
            direction: rtl;
            text-align: right;
        }

        .slide-content-editable:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
            display: block; /* For Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col text-gray-800">

    <!-- מסך טעינה -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loader mb-4"></div>
        <h2 id="loadingText" class="text-xl font-bold text-gray-700">מעבד נתונים...</h2>
        <p class="text-sm text-gray-500">ה-AI עובד על המצגת שלך, זה עשוי לקחת מספר שניות</p>
    </div>

    <!-- כותרת עליונה -->
    <header class="bg-white shadow-sm z-10 border-b border-gray-200">
        <div class="max-w-screen-2xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fas fa-magic text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">SlideGenius AI</h1>
                    <p class="text-xs text-gray-500">מחולל מצגות חכם</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div id="apiKeyStatus" class="text-xs px-2 py-1 rounded bg-red-100 text-red-600 font-medium">
                    <i class="fas fa-exclamation-circle ml-1"></i> חסר מפתח API
                </div>
                <button onclick="app.ui.toggleSettings()" class="text-gray-600 hover:text-blue-600 transition">
                    <i class="fas fa-cog text-lg"></i>
                </button>
                <button onclick="app.exportManager.exportToPptx()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow flex items-center gap-2 transition font-medium">
                    <i class="fas fa-file-powerpoint"></i> ייצוא ל-PPTX
                </button>
            </div>
        </div>
    </header>

    <!-- אזור ראשי -->
    <main class="flex-1 flex overflow-hidden max-w-screen-2xl mx-auto w-full">
        
        <!-- סרגל צד - ניהול שקפים -->
        <aside class="w-72 bg-white border-l border-gray-200 flex flex-col shadow-inner">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">שקפים</h3>
                    <span id="slideCount" class="text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600">0</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.state.undo()" class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-600 py-1 rounded text-sm transition" title="בטל">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button onclick="app.state.redo()" class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-600 py-1 rounded text-sm transition" title="בצע שוב">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button onclick="app.slidesManager.addNewSlide()" class="flex-1 bg-blue-50 border border-blue-200 hover:bg-blue-100 text-blue-600 py-1 rounded text-sm transition" title="הוסף שקף">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div id="slidesList" class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                <!-- רשימת השקפים תיווצר כאן דינמית -->
                <div class="text-center text-gray-400 mt-10">
                    <i class="fas fa-images text-4xl mb-2"></i>
                    <p>אין שקפים כרגע</p>
                </div>
            </div>
        </aside>

        <!-- אזור עריכה ותצוגה -->
        <section class="flex-1 flex flex-col bg-gray-100 overflow-hidden relative">
            
            <!-- סרגל כלים עליון לפעולות AI -->
            <div class="bg-white p-3 border-b border-gray-200 flex items-center gap-3 shadow-sm z-20">
                <div class="flex-1 relative">
                    <input type="text" id="aiPromptInput" placeholder="על מה תרצה שאכין מצגת? (למשל: יתרונות הבינה המלאכותית ברפואה)" 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    <i class="fas fa-magic absolute left-3 top-3 text-blue-500"></i>
                </div>
                <button onclick="app.ai.generateFullPresentation()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-2 rounded-lg shadow hover:opacity-90 transition flex items-center gap-2 whitespace-nowrap font-medium">
                    <i class="fas fa-sparkles"></i> צור מצגת
                </button>
                
                <div class="h-8 w-px bg-gray-300 mx-2"></div>

                <!-- כפתורי כלים נוספים -->
                <div class="flex gap-2">
                    <button onclick="app.ai.proofreadCurrentSlide()" class="text-gray-600 hover:text-blue-600 bg-gray-50 hover:bg-blue-50 p-2 rounded-lg transition" title="בדיקת דקדוק וניסוח">
                        <i class="fas fa-spell-check"></i>
                    </button>
                    <button onclick="app.ai.suggestImage()" class="text-gray-600 hover:text-purple-600 bg-gray-50 hover:bg-purple-50 p-2 rounded-lg transition" title="החלף תמונה עם AI">
                        <i class="fas fa-image"></i>
                    </button>
                    <button onclick="app.ai.summarizeToSlide()" class="text-gray-600 hover:text-green-600 bg-gray-50 hover:bg-green-50 p-2 rounded-lg transition" title="סיכום טקסט לשקף">
                        <i class="fas fa-file-alt"></i>
                    </button>
                    <button onclick="app.ai.generateQuizSlide()" class="text-gray-600 hover:text-orange-600 bg-gray-50 hover:bg-orange-50 p-2 rounded-lg transition" title="צור שקף חידון">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>

            <!-- אזור הקנבס של השקף -->
            <div class="flex-1 overflow-auto p-8 flex justify-center items-start">
                <div id="slideEditor" class="bg-white w-full max-w-4xl aspect-video shadow-2xl rounded-sm flex overflow-hidden relative transition-all duration-300 transform">
                    <!-- תוכן השקף ירונדר כאן -->
                    <div class="w-full h-full flex items-center justify-center text-gray-300">
                        <div class="text-center">
                            <i class="fas fa-mouse-pointer text-5xl mb-4"></i>
                            <p class="text-xl">בחר שקף לעריכה או צור חדש</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- פאנל עריכה מהיר -->
            <div class="bg-white border-t border-gray-200 p-3 flex justify-between items-center text-sm text-gray-600">
                <div class="flex gap-4">
                    <select id="themeSelector" onchange="app.themeManager.setTheme(this.value)" class="border border-gray-300 rounded px-2 py-1 outline-none">
                        <option value="modern">עיצוב: מודרני נקי</option>
                        <option value="dark">עיצוב: כהה אלגנטי</option>
                        <option value="colorful">עיצוב: צבעוני וחי</option>
                        <option value="minimal">עיצוב: מינימליסטי</option>
                        <option value="corporate">עיצוב: עסקי</option>
                    </select>
                    <div class="flex items-center gap-2 border-r border-gray-300 pr-4">
                        <label class="cursor-pointer flex items-center gap-1 hover:text-blue-600">
                            <i class="fas fa-fill-drip"></i>
                            <input type="color" id="bgColorPicker" class="w-5 h-5 opacity-0 absolute" onchange="app.slidesManager.updateSlideStyle('backgroundColor', this.value)">
                            <span>רקע</span>
                        </label>
                    </div>
                </div>
                <div>
                    <span id="saveStatus" class="text-green-600"><i class="fas fa-check"></i> נשמר</span>
                </div>
            </div>
        </section>
    </main>

    <!-- מודאל הגדרות -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">הגדרות מערכת</h3>
                <button onclick="app.ui.toggleSettings()" class="hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="הדבק כאן את המפתח...">
                        <button onclick="app.settings.saveApiKey()" class="absolute left-2 top-2 text-blue-600 text-sm font-bold hover:text-blue-800">שמור</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">המפתח נשמר מקומית בדפדפן שלך בלבד.</p>
                </div>

                <div class="border-t pt-4">
                    <h4 class="font-bold text-sm text-gray-700 mb-2">ניהול גרסאות</h4>
                    <div id="versionHistoryList" class="max-h-32 overflow-y-auto space-y-2 text-sm border rounded p-2 bg-gray-50">
                        <!-- רשימת גרסאות -->
                    </div>
                </div>

                <div class="border-t pt-4">
                    <button onclick="app.settings.clearAllData()" class="w-full text-red-600 border border-red-200 bg-red-50 hover:bg-red-100 px-4 py-2 rounded-lg transition text-sm">
                        <i class="fas fa-trash-alt ml-1"></i> אפס את כל הנתונים
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל סיכום טקסט -->
    <div id="summaryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">סיכום טקסט לשקפים</h3>
                <button onclick="app.ui.toggleModal('summaryModal')" class="hover:text-blue-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <textarea id="textToSummarize" class="w-full h-48 border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="הדבק כאן את הטקסט הארוך שברצונך להפוך למצגת..."></textarea>
                <div class="mt-4 flex justify-end gap-2">
                    <button onclick="app.ui.toggleModal('summaryModal')" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded">ביטול</button>
                    <button onclick="app.ai.processSummary()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition shadow">צור שקפים מהטקסט</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * SlideGenius AI - Core Application Code
         * כולל את כל הלוגיקה: ניהול מצב, AI, עיצוב וייצוא.
         */

        class Utils {
            static generateId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }

            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            static getContrastColor(hexcolor) {
                // חישוב צבע טקסט (שחור/לבן) לפי רקע
                if (!hexcolor) return '#000000';
                hexcolor = hexcolor.replace("#", "");
                var r = parseInt(hexcolor.substr(0, 2), 16);
                var g = parseInt(hexcolor.substr(2, 2), 16);
                var b = parseInt(hexcolor.substr(4, 2), 16);
                var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#ffffff';
            }
        }

        class ThemeManager {
            constructor() {
                this.themes = {
                    modern: { bg: '#ffffff', text: '#1f2937', accent: '#3b82f6', font: 'Heebo', titleSize: '2.5rem', layout: 'standard' },
                    dark: { bg: '#111827', text: '#f3f4f6', accent: '#60a5fa', font: 'Heebo', titleSize: '2.5rem', layout: 'standard' },
                    colorful: { bg: '#fff7ed', text: '#431407', accent: '#f97316', font: 'Heebo', titleSize: '3rem', layout: 'centered' },
                    minimal: { bg: '#fafafa', text: '#333333', accent: '#000000', font: 'Courier New', titleSize: '2rem', layout: 'minimal' },
                    corporate: { bg: '#f8fafc', text: '#0f172a', accent: '#0f766e', font: 'Arial', titleSize: '2.2rem', layout: 'standard' }
                };
                this.currentTheme = 'modern';
            }

            setTheme(themeName) {
                if (this.themes[themeName]) {
                    this.currentTheme = themeName;
                    app.slidesManager.renderCurrentSlide();
                }
            }

            getThemeStyle() {
                return this.themes[this.currentTheme];
            }
        }

        class HistoryManager {
            constructor() {
                this.undoStack = [];
                this.redoStack = [];
                this.maxHistory = 20;
            }

            saveState(slides, currentIndex) {
                const state = JSON.stringify({ slides, currentIndex });
                // מניעת כפילויות רצופות
                if (this.undoStack.length > 0 && this.undoStack[this.undoStack.length - 1] === state) return;
                
                this.undoStack.push(state);
                if (this.undoStack.length > this.maxHistory) this.undoStack.shift();
                this.redoStack = []; // ניקוי ה-Redo בשינוי חדש
                app.ui.updateHistoryButtons();
            }

            undo() {
                if (this.undoStack.length === 0) return null;
                const currentState = JSON.stringify({ 
                    slides: app.slidesManager.slides, 
                    currentIndex: app.slidesManager.currentSlideIndex 
                });
                this.redoStack.push(currentState);
                
                const prevState = JSON.parse(this.undoStack.pop());
                app.ui.updateHistoryButtons();
                return prevState;
            }

            redo() {
                if (this.redoStack.length === 0) return null;
                const currentState = JSON.stringify({ 
                    slides: app.slidesManager.slides, 
                    currentIndex: app.slidesManager.currentSlideIndex 
                });
                this.undoStack.push(currentState);
                
                const nextState = JSON.parse(this.redoStack.pop());
                app.ui.updateHistoryButtons();
                return nextState;
            }
        }

        class SlidesManager {
            constructor() {
                this.slides = [];
                this.currentSlideIndex = -1;
                this.sortable = null;
            }

            loadSlides(slidesData, index = 0) {
                this.slides = slidesData;
                this.currentSlideIndex = slidesData.length > 0 ? index : -1;
                this.renderSlideList();
                this.renderCurrentSlide();
                this.updateSlideCount();
            }

            addNewSlide(type = 'content') {
                app.state.saveToHistory();
                const newSlide = {
                    id: Utils.generateId(),
                    title: 'כותרת שקף חדש',
                    content: ['נקודה ראשונה', 'נקודה שניה'],
                    image: '',
                    notes: '',
                    layout: 'standard', // standard, split, title-only, quote
                    style: {} // Custom overrides
                };
                
                this.slides.push(newSlide);
                this.currentSlideIndex = this.slides.length - 1;
                this.refreshAll();
            }

            deleteSlide(index) {
                app.state.saveToHistory();
                this.slides.splice(index, 1);
                if (this.currentSlideIndex >= this.slides.length) {
                    this.currentSlideIndex = this.slides.length - 1;
                }
                this.refreshAll();
            }

            duplicateSlide(index) {
                app.state.saveToHistory();
                const slide = JSON.parse(JSON.stringify(this.slides[index]));
                slide.id = Utils.generateId();
                slide.title += ' (עותק)';
                this.slides.splice(index + 1, 0, slide);
                this.currentSlideIndex = index + 1;
                this.refreshAll();
            }

            selectSlide(index) {
                this.currentSlideIndex = index;
                this.renderCurrentSlide();
                this.highlightActiveSlideInList();
            }

            updateSlideContent(field, value) {
                // אין שמירה להיסטוריה בכל הקשה, אלא ב-blur או debounce (מטופל ב-UI)
                if (this.currentSlideIndex === -1) return;
                
                if (field === 'title') this.slides[this.currentSlideIndex].title = value;
                else if (field === 'notes') this.slides[this.currentSlideIndex].notes = value;
                else if (field === 'image') this.slides[this.currentSlideIndex].image = value;
                
                // עדכון ויזואלי ברשימה רק אם הכותרת השתנתה
                if (field === 'title') this.updateListItemTitle(this.currentSlideIndex, value);
                
                app.ui.showSaveStatus();
            }

            updateSlidePoints(htmlContent) {
                if (this.currentSlideIndex === -1) return;
                // המרת HTML לרשימה
                const parser = new DOMParser();
                const doc = parser.parseFromString(`<ul>${htmlContent}</ul>`, 'text/html');
                const items = Array.from(doc.querySelectorAll('li')).map(li => li.innerText);
                this.slides[this.currentSlideIndex].content = items;
                app.ui.showSaveStatus();
            }

            updateSlideStyle(property, value) {
                if (this.currentSlideIndex === -1) return;
                app.state.saveToHistory();
                if (!this.slides[this.currentSlideIndex].style) this.slides[this.currentSlideIndex].style = {};
                this.slides[this.currentSlideIndex].style[property] = value;
                this.renderCurrentSlide();
            }

            reorderSlides(oldIndex, newIndex) {
                app.state.saveToHistory();
                const item = this.slides.splice(oldIndex, 1)[0];
                this.slides.splice(newIndex, 0, item);
                this.currentSlideIndex = newIndex;
                this.renderCurrentSlide(); // כדי לוודא סנכרון
            }

            refreshAll() {
                this.renderSlideList();
                this.renderCurrentSlide();
                this.updateSlideCount();
            }

            updateSlideCount() {
                document.getElementById('slideCount').innerText = this.slides.length;
            }

            updateListItemTitle(index, newTitle) {
                const el = document.querySelector(`[data-index="${index}"] .slide-title-preview`);
                if (el) el.innerText = newTitle;
            }

            highlightActiveSlideInList() {
                document.querySelectorAll('.slide-preview-card').forEach(el => el.classList.remove('active'));
                const active = document.querySelector(`.slide-preview-card[data-index="${this.currentSlideIndex}"]`);
                if (active) {
                    active.classList.add('active');
                    active.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            renderSlideList() {
                const list = document.getElementById('slidesList');
                list.innerHTML = '';
                
                if (this.slides.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="fas fa-images text-4xl mb-2"></i><p>אין שקפים</p></div>`;
                    return;
                }

                this.slides.forEach((slide, index) => {
                    const div = document.createElement('div');
                    div.className = `slide-preview-card bg-white p-3 rounded-lg shadow-sm cursor-pointer mb-2 relative group ${index === this.currentSlideIndex ? 'active' : ''}`;
                    div.dataset.index = index;
                    div.onclick = (e) => {
                        if (!e.target.closest('button')) this.selectSlide(index);
                    };

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-bold text-gray-400">#${index + 1}</span>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                <button onclick="app.slidesManager.duplicateSlide(${index})" class="text-gray-500 hover:text-blue-500 p-1" title="שכפל"><i class="far fa-copy"></i></button>
                                <button onclick="app.slidesManager.deleteSlide(${index})" class="text-gray-500 hover:text-red-500 p-1" title="מחק"><i class="far fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <h4 class="font-medium text-sm text-gray-800 truncate slide-title-preview w-full" dir="auto">${slide.title || 'ללא כותרת'}</h4>
                        <div class="h-1 w-full bg-gray-100 mt-2 rounded overflow-hidden">
                            <div class="h-full bg-blue-200" style="width: ${slide.content.length * 10}%"></div>
                        </div>
                    `;
                    list.appendChild(div);
                });

                // הפעלת SortableJS
                if (this.sortable) this.sortable.destroy();
                this.sortable = new Sortable(list, {
                    animation: 150,
                    ghostClass: 'bg-blue-50',
                    onEnd: (evt) => {
                        this.reorderSlides(evt.oldIndex, evt.newIndex);
                    }
                });
            }

            renderCurrentSlide() {
                const container = document.getElementById('slideEditor');
                if (this.currentSlideIndex === -1 || !this.slides[this.currentSlideIndex]) {
                    container.innerHTML = `
                        <div class="w-full h-full flex items-center justify-center text-gray-300">
                            <div class="text-center">
                                <i class="fas fa-mouse-pointer text-5xl mb-4"></i>
                                <p class="text-xl">בחר שקף לעריכה או צור חדש</p>
                            </div>
                        </div>`;
                    return;
                }

                const slide = this.slides[this.currentSlideIndex];
                const theme = app.themeManager.getThemeStyle();
                
                // סגנונות מותאמים אישית לשקף הספציפי גוברים על התבנית
                const bgColor = slide.style?.backgroundColor || theme.bg;
                const textColor = slide.style?.textColor || theme.text;
                const accentColor = slide.style?.accentColor || theme.accent;

                // יצירת מבנה השקף בהתאם ללייאאוט
                let innerHTML = '';
                
                // כפתור מחיקת תמונה
                const imgControls = slide.image ? 
                    `<div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="app.slidesManager.updateSlideContent('image', '')" class="bg-red-500 text-white p-1 rounded text-xs">הסר</button>
                     </div>` : '';

                const imageHtml = slide.image ? 
                    `<div class="relative w-full h-full group">
                        <img src="${slide.image}" class="w-full h-full object-cover rounded-lg shadow-md" alt="Slide Image" onerror="this.src='https://via.placeholder.com/400x300?text=Image+Error'">
                        ${imgControls}
                     </div>` : 
                    `<div class="w-full h-full border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-blue-400 transition" onclick="app.ai.suggestImage()">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <span class="text-sm">לחץ כדי להוסיף תמונה (AI)</span>
                     </div>`;

                if (theme.layout === 'centered') {
                     innerHTML = `
                        <div class="flex flex-col items-center justify-center text-center h-full p-12">
                            <h2 contenteditable="true" class="font-bold outline-none border-b-2 border-transparent focus:border-blue-400 mb-6" 
                                style="font-size: ${theme.titleSize}; color: ${accentColor};"
                                onblur="app.slidesManager.updateSlideContent('title', this.innerText)"
                                onfocus="app.state.saveToHistory()">${slide.title}</h2>
                            
                            <div class="w-2/3 mb-6">
                                <ul contenteditable="true" class="text-2xl space-y-2 outline-none"
                                    onblur="app.slidesManager.updateSlidePoints(this.innerHTML)"
                                    onfocus="app.state.saveToHistory()">
                                    ${slide.content.map(p => `<li>${p}</li>`).join('')}
                                </ul>
                            </div>
                            
                            ${slide.image ? `<div class="w-1/3 h-40 mt-4">${imageHtml}</div>` : ''}
                        </div>
                     `;
                } else {
                    // Standard Split Layout
                    innerHTML = `
                        <div class="flex flex-col h-full p-8 md:p-12 relative">
                            <div class="mb-6 border-b-4 pb-2" style="border-color: ${accentColor}">
                                <h2 contenteditable="true" class="font-bold outline-none" 
                                    style="font-size: ${theme.titleSize}; color: ${accentColor};"
                                    onblur="app.slidesManager.updateSlideContent('title', this.innerText)"
                                    onfocus="app.state.saveToHistory()">${slide.title}</h2>
                            </div>
                            
                            <div class="flex-1 flex gap-8 overflow-hidden">
                                <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                                    <ul contenteditable="true" class="text-xl md:text-2xl space-y-4 outline-none list-disc list-inside"
                                        style="color: ${textColor}"
                                        onblur="app.slidesManager.updateSlidePoints(this.innerHTML)"
                                        onfocus="app.state.saveToHistory()">
                                        ${slide.content.map(p => `<li>${p}</li>`).join('')}
                                    </ul>
                                    
                                    <div class="mt-6 pt-4 border-t border-gray-200/50">
                                        <label class="text-xs uppercase font-bold opacity-50 block mb-1">הערות דובר (לא יוצג במצגת)</label>
                                        <p contenteditable="true" class="text-sm italic opacity-70 outline-none"
                                           onblur="app.slidesManager.updateSlideContent('notes', this.innerText)">${slide.notes || 'לחץ להוספת הערות...'}</p>
                                    </div>
                                </div>
                                <div class="flex-1 h-full flex items-center justify-center">
                                    ${imageHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = `<div class="w-full h-full shadow-lg relative transition-colors duration-500" style="background-color: ${bgColor}; font-family: ${theme.font}; color: ${textColor}">${innerHTML}</div>`;
            }
        }

        class AIManager {
            constructor() {
                this.apiEndpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
            }

            getApiKey() {
                return localStorage.getItem('gemini_api_key');
            }

            async callGemini(promptText, systemInstruction = "") {
                const apiKey = this.getApiKey();
                if (!apiKey) {
                    alert('נא להזין מפתח API של Gemini בהגדרות');
                    app.ui.toggleSettings();
                    throw new Error('No API Key');
                }

                app.ui.toggleLoading(true);

                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: promptText }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                            responseMimeType: "application/json"
                        }
                    };

                    if (systemInstruction) {
                        payload.systemInstruction = { parts: [{ text: systemInstruction }] };
                    }

                    const response = await fetch(`${this.apiEndpoint}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || 'API Error');
                    }

                    const data = await response.json();
                    const textResponse = data.candidates[0].content.parts[0].text;
                    return JSON.parse(textResponse);

                } catch (error) {
                    console.error('Gemini Error:', error);
                    alert('שגיאה בתקשורת עם ה-AI: ' + error.message);
                    return null;
                } finally {
                    app.ui.toggleLoading(false);
                }
            }

            async generateFullPresentation() {
                const topic = document.getElementById('aiPromptInput').value;
                if (!topic) return alert('נא להזין נושא למצגת');

                const systemPrompt = `
                אתה מומחה ליצירת מצגות. המשתמש יבקש מצגת בנושא מסוים.
                עליך להחזיר מערך JSON של אובייקטים, כאשר כל אובייקט מייצג שקף.
                מבנה האובייקט:
                {
                    "title": "כותרת השקף",
                    "content": ["נקודה 1", "נקודה 2", "נקודה 3"],
                    "imageKeyword": "מילת מפתח באנגלית לחיפוש תמונה (מילה אחת או שתיים)",
                    "notes": "הערות דובר והסבר מורחב"
                }
                צור לפחות 5 שקפים ועד 8.
                הקפד על תוכן עשיר ומקצועי בעברית.
                בשדה imageKeyword השתמש באנגלית בלבד.
                נושא המצגת: ${topic}
                `;

                const result = await this.callGemini(`צור מצגת בנושא: ${topic}`, systemPrompt);
                
                if (result) {
                    app.state.saveToHistory();
                    // עיבוד התוצאה והוספת URL לתמונות
                    const processedSlides = result.map(s => ({
                        id: Utils.generateId(),
                        title: s.title,
                        content: s.content,
                        image: s.imageKeyword ? `https://image.pollinations.ai/prompt/${encodeURIComponent(s.imageKeyword)}?width=800&height=600&nologo=true` : '',
                        notes: s.notes,
                        style: {}
                    }));
                    
                    app.slidesManager.loadSlides(processedSlides);
                    app.ui.showToast('המצגת נוצרה בהצלחה!');
                }
            }

            async suggestImage() {
                if (app.slidesManager.currentSlideIndex === -1) return;
                const slide = app.slidesManager.slides[app.slidesManager.currentSlideIndex];
                
                const prompt = `
                עבור שקף עם הכותרת: "${slide.title}" והתוכן: "${slide.content.join(', ')}".
                תן לי מילת מפתח אחת או שתיים באנגלית לחיפוש תמונה מתאימה שתמחיש את הנושא בצורה ויזואלית חזקה.
                החזר JSON בפורמט: { "keyword": "..." }
                `;

                const result = await this.callGemini(prompt);
                if (result && result.keyword) {
                    const newUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(result.keyword)}?width=800&height=600&nologo=true&seed=${Math.random()}`;
                    app.slidesManager.updateSlideContent('image', newUrl);
                    app.slidesManager.renderCurrentSlide();
                }
            }

            async proofreadCurrentSlide() {
                if (app.slidesManager.currentSlideIndex === -1) return;
                const slide = app.slidesManager.slides[app.slidesManager.currentSlideIndex];
                
                const prompt = `
                תקן שגיאות כתיב, דקדוק ושפר את הניסוח של הטקסטים הבאים בשקף מצגת.
                שמור על אותו מבנה JSON.
                החזר JSON:
                {
                    "title": "כותרת משופרת",
                    "content": ["נקודה משופרת 1", ...]
                }
                
                הקלט:
                כותרת: ${slide.title}
                תוכן: ${JSON.stringify(slide.content)}
                `;

                const result = await this.callGemini(prompt);
                if (result) {
                    app.state.saveToHistory();
                    slide.title = result.title;
                    slide.content = result.content;
                    app.slidesManager.refreshAll();
                    app.ui.showToast('הטקסט שופר בהצלחה');
                }
            }

            async generateQuizSlide() {
                const slidesContent = app.slidesManager.slides.map(s => s.title + ": " + s.content.join(", ")).join("\n");
                
                const prompt = `
                בהתבסס על תוכן המצגת הבא, צור שקף חידון אמריקאי עם שאלה אחת מאתגרת ו-3 תשובות (אחת נכונה).
                החזר JSON:
                {
                    "title": "חידון: [נושא השאלה]",
                    "content": ["שאלה: [השאלה]", "1. [תשובה]", "2. [תשובה]", "3. [תשובה]"],
                    "notes": "התשובה הנכונה היא: ..."
                }
                
                תוכן המצגת:
                ${slidesContent}
                `;

                const result = await this.callGemini(prompt);
                if (result) {
                    app.state.saveToHistory();
                    app.slidesManager.slides.push({
                        id: Utils.generateId(),
                        title: result.title,
                        content: result.content,
                        image: `https://image.pollinations.ai/prompt/quiz question mark?width=800&height=600&nologo=true`,
                        notes: result.notes,
                        style: { backgroundColor: '#eef2ff' } // רקע מיוחד לחידון
                    });
                    app.slidesManager.currentSlideIndex = app.slidesManager.slides.length - 1;
                    app.slidesManager.refreshAll();
                }
            }

            async summarizeToSlide() {
                // נפתח מודאל, הקוד ב-UiManager מטפל בהצגתו
                app.ui.toggleModal('summaryModal');
            }

            async processSummary() {
                const text = document.getElementById('textToSummarize').value;
                if (!text) return alert('אין טקסט לסיכום');
                app.ui.toggleModal('summaryModal'); // סגור מודאל

                const prompt = `
                סכם את הטקסט הבא ל-3 עד 5 שקפי מצגת.
                עבור כל שקף, החזר כותרת, נקודות עיקריות ומילת מפתח לתמונה באנגלית.
                פורמט JSON מערך אובייקטים.
                
                הטקסט:
                ${text.substring(0, 10000)}
                `;

                const result = await this.callGemini(prompt);
                if (result) {
                    app.state.saveToHistory();
                    const newSlides = result.map(s => ({
                        id: Utils.generateId(),
                        title: s.title,
                        content: s.content,
                        image: s.imageKeyword ? `https://image.pollinations.ai/prompt/${encodeURIComponent(s.imageKeyword)}?width=800&height=600&nologo=true` : '',
                        notes: 'נוצר מסיכום אוטומטי',
                        style: {}
                    }));
                    
                    // הוסף לסוף או החלף הכל? המשתמש בדרך כלל רוצה מצגת חדשה או להוסיף.
                    // נוסיף לסוף.
                    app.slidesManager.slides = [...app.slidesManager.slides, ...newSlides];
                    if (app.slidesManager.currentSlideIndex === -1) app.slidesManager.currentSlideIndex = 0;
                    app.slidesManager.refreshAll();
                }
            }
        }

        class ExportManager {
            async exportToPptx() {
                if (app.slidesManager.slides.length === 0) return alert('אין שקפים לייצוא');

                const pptx = new PptxGenJS();
                pptx.layout = 'LAYOUT_16x9';
                pptx.rtlMode = true;

                // הגדרת מטא-דאטה
                pptx.author = 'SlideGenius AI';
                pptx.title = app.slidesManager.slides[0].title || 'Presentation';

                for (const slideData of app.slidesManager.slides) {
                    const slide = pptx.addSlide();
                    const theme = app.themeManager.getThemeStyle();
                    
                    // צבעים
                    const bg = (slideData.style?.backgroundColor || theme.bg).replace('#', '');
                    const color = (slideData.style?.textColor || theme.text).replace('#', '');
                    const accent = (slideData.style?.accentColor || theme.accent).replace('#', '');

                    slide.background = { color: bg };
                    slide.color = color;

                    // כותרת
                    slide.addText(slideData.title, { 
                        x: 0.5, y: 0.5, w: '90%', h: 1, 
                        fontSize: 32, bold: true, color: accent, align: 'right', dir: 'rtl', fontFace: 'Arial'
                    });

                    // תוכן
                    slide.addText(slideData.content.map(c => ({ text: c, options: { breakLine: true } })), {
                        x: 0.5, y: 1.8, w: '50%', h: 4,
                        fontSize: 18, color: color, align: 'right', dir: 'rtl',
                        bullet: { code: '2022' }, fontFace: 'Arial'
                    });

                    // תמונה
                    if (slideData.image) {
                        try {
                            // PptxGenJS תומך ב-URL, אבל לעיתים יש בעיות CORS. 
                            // ה-lib מנסה להוריד לבד.
                            slide.addImage({ 
                                path: slideData.image, 
                                x: '55%', y: 1.8, w: '40%', h: 3.5,
                                sizing: { type: 'cover', w: '40%', h: 3.5 }
                            });
                        } catch (e) {
                            console.error("Image error", e);
                        }
                    }

                    // הערות
                    if (slideData.notes) {
                        slide.addNotes(slideData.notes);
                    }
                }

                pptx.writeFile({ fileName: `SlideGenius_${new Date().toISOString().slice(0,10)}.pptx` });
            }
        }

        class SettingsManager {
            constructor() {
                this.loadApiKey();
            }

            loadApiKey() {
                const key = localStorage.getItem('gemini_api_key');
                if (key) {
                    document.getElementById('apiKeyInput').value = key;
                    document.getElementById('apiKeyStatus').classList.add('hidden');
                }
            }

            saveApiKey() {
                const key = document.getElementById('apiKeyInput').value.trim();
                if (key) {
                    localStorage.setItem('gemini_api_key', key);
                    document.getElementById('apiKeyStatus').classList.add('hidden');
                    app.ui.showToast('מפתח API נשמר!');
                    app.ui.toggleSettings(); // סגור מודאל
                }
            }

            clearAllData() {
                if(confirm('האם אתה בטוח? כל ההיסטוריה והמפתח יימחקו.')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        class UIManager {
            toggleSettings() {
                const modal = document.getElementById('settingsModal');
                modal.classList.toggle('hidden');
            }

            toggleModal(id) {
                document.getElementById(id).classList.toggle('hidden');
            }

            toggleLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (show) overlay.classList.remove('hidden');
                else overlay.classList.add('hidden');
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-5 left-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce';
                toast.innerText = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            showSaveStatus() {
                const el = document.getElementById('saveStatus');
                el.style.opacity = '1';
                setTimeout(() => el.style.opacity = '0.5', 2000);
            }

            updateHistoryButtons() {
                // יכול לשמש להפעלה/כיבוי ויזואלי של כפתורי undo/redo
            }
        }

        class AppState {
            constructor() {
                this.slidesManager = new SlidesManager();
                this.historyManager = new HistoryManager();
                this.themeManager = new ThemeManager();
                this.ai = new AIManager();
                this.exportManager = new ExportManager();
                this.settings = new SettingsManager();
                this.ui = new UIManager();
            }

            saveToHistory() {
                this.historyManager.saveState(
                    JSON.parse(JSON.stringify(this.slidesManager.slides)),
                    this.slidesManager.currentSlideIndex
                );
            }

            init() {
                // בדיקה אם יש שמירה מקומית של מצגת אחרונה (Auto-recovery)
                // לצורך הפשטות בקוד זה, נתחיל נקי.
                this.slidesManager.renderSlideList();
                this.slidesManager.renderCurrentSlide();

                // האזנה לקיצורי מקלדת
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        this.state.undo();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                        e.preventDefault();
                        this.state.redo();
                    }
                });
            }

            // Wrapper for History Access via global 'app'
            get state() {
                return {
                    undo: () => {
                        const state = this.historyManager.undo();
                        if (state) this.slidesManager.loadSlides(state.slides, state.currentIndex);
                    },
                    redo: () => {
                        const state = this.historyManager.redo();
                        if (state) this.slidesManager.loadSlides(state.slides, state.currentIndex);
                    },
                    saveToHistory: () => this.saveToHistory()
                };
            }
        }

        // אתחול האפליקציה
        const app = new AppState();
        
        // חשיפה ל-Window כדי שה-HTML יוכל לקרוא לפונקציות
        window.app = app;
        
        // הרצה ראשונית
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
