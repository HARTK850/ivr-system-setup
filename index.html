<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini GIF Maker Pro</title>
    <!-- ×˜×¢×™× ×ª ×¡×¤×¨×™×™×ª ×™×¦×™×¨×ª ×”-GIF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <style>
        :root {
            --primary: #8AB4F8;
            --primary-hover: #669DF6;
            --bg-dark: #202124;
            --bg-card: #2D2E31;
            --text-main: #E8EAED;
            --text-secondary: #9AA0A6;
            --border: #3C4043;
            --danger: #F28B82;
            --success: #81C995;
            --radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Header & API Key --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #4285F4, #9B72CB, #F867B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .api-controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: var(--primary);
            color: #202124;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        button.outline:hover {
            border-color: var(--primary);
        }

        /* --- Input Section --- */
        .card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        input[type="text"], textarea, input[type="password"] {
            background: #171717;
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 6px;
            width: 100%;
            font-size: 1rem;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .controls-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .control-item {
            flex: 1;
            min-width: 150px;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--primary);
        }

        /* --- Gallery & Preview --- */
        .workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .workspace {
                grid-template-columns: 1fr;
            }
        }

        .frames-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            min-height: 200px;
            align-content: start;
        }

        .frame-card {
            background: #171717;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1;
            border: 2px solid transparent;
            cursor: grab;
            transition: transform 0.2s;
        }

        .frame-card.dragging {
            opacity: 0.5;
            border-color: var(--primary);
        }

        .frame-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .frame-card .delete-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: var(--danger);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 14px;
        }

        .frame-number {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .preview-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        #gifPreview {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
            background: #000;
            border-radius: 8px;
            object-fit: contain;
            border: 1px solid var(--border);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* --- Utils --- */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #3C4043;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }

        .status-msg {
            font-size: 0.9rem;
            margin-top: 10px;
            min-height: 1.2em;
        }

        .status-error { color: var(--danger); }
        .status-success { color: var(--success); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal-overlay">
        <div class="modal">
            <h2>ğŸ” ×”×’×“×¨×ª ××¤×ª×—</h2>
            <p style="margin: 15px 0; color: var(--text-secondary);">×›×“×™ ×œ×”×©×ª××© ×‘-Gemini, ×¢×œ×™×š ×œ×”×–×™×Ÿ API Key.</p>
            <input type="password" id="apiKeyInput" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”××¤×ª×— (AIza...)" style="margin-bottom: 20px;">
            <button onclick="saveApiKey()">×©××•×¨ ×•×”×ª×—×œ</button>
            <p style="margin-top: 10px; font-size: 0.8rem;">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary);">×”×©×’ ××¤×ª×— ×›××Ÿ</a>
            </p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>âœ¨ Gemini GIF Pro</h1>
            <div class="api-controls">
                <span id="apiStatus" style="font-size: 0.8rem; color: var(--success); display: flex; align-items: center;"></span>
                <button class="outline" onclick="changeApiKey()">×©×™× ×•×™ ××¤×ª×—</button>
            </div>
        </header>

        <!-- Generation Controls -->
        <div class="card">
            <div class="input-group">
                <div>
                    <label>×ª×™××•×¨ ×”×ª××•× ×” (Prompt)</label>
                    <textarea id="promptInput" rows="2" placeholder="×œ××©×œ: A futuristic robot dancing in neon city, pixel art style"></textarea>
                </div>
                
                <div class="controls-row">
                    <div class="control-item">
                        <label>××¡×¤×¨ ×¤×¨×™×™××™×: <span id="framesCountVal">4</span></label>
                        <input type="range" id="framesCount" min="2" max="8" value="4" oninput="document.getElementById('framesCountVal').innerText = this.value">
                    </div>
                    <div class="control-item">
                        <label>×¡×’× ×•×Ÿ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="text" id="styleInput" placeholder="Cinematic, Cartoon, Oil Painting...">
                    </div>
                </div>

                <button id="generateBtn" onclick="startGeneration()">
                    ğŸ¨ ×¦×•×¨ ×ª××•× ×•×ª
                </button>
                <div id="genStatus" class="status-msg"></div>
            </div>
        </div>

        <!-- Workspace -->
        <div class="workspace">
            <!-- Frames Area -->
            <div class="card">
                <h3>ğŸï¸ ×¤×¨×™×™××™× (×¡×“×¨ ×‘×’×¨×™×¨×”)</h3>
                <div id="framesList" class="frames-container">
                    <p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center; padding: 20px;">
                        ×˜×¨× × ×•×¦×¨×• ×ª××•× ×•×ª.
                    </p>
                </div>
            </div>

            <!-- Preview Area -->
            <div class="card preview-area">
                <h3>ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”</h3>
                <img id="gifPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" alt="GIF Preview">
                
                <div style="width: 100%;">
                    <label>××”×™×¨×•×ª (FPS): <span id="fpsVal">5</span></label>
                    <input type="range" id="fpsInput" min="1" max="20" value="5" oninput="updateFPS(this.value)">
                </div>

                <button id="createGifBtn" onclick="renderGIF()" disabled>
                    ğŸï¸ ×¦×•×¨ GIF
                </button>
                <a id="downloadLink" style="display: none;"></a>
                
                <div style="width: 100%;">
                    <div class="progress-bar">
                        <div id="gifProgress" class="progress-fill"></div>
                    </div>
                    <div id="gifStatus" class="status-msg" style="text-align: center;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ› ï¸ State Management
        // ==========================================
        let API_KEY = localStorage.getItem('GEMINI_API_KEY');
        let frames = []; // Array of base64 images
        let gifInstance = null;
        
        // DOM Elements
        const els = {
            apiKeyModal: document.getElementById('apiKeyModal'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            promptInput: document.getElementById('promptInput'),
            styleInput: document.getElementById('styleInput'),
            framesCount: document.getElementById('framesCount'),
            generateBtn: document.getElementById('generateBtn'),
            genStatus: document.getElementById('genStatus'),
            framesList: document.getElementById('framesList'),
            gifPreview: document.getElementById('gifPreview'),
            createGifBtn: document.getElementById('createGifBtn'),
            gifProgress: document.getElementById('gifProgress'),
            gifStatus: document.getElementById('gifStatus'),
            fpsInput: document.getElementById('fpsInput'),
            fpsVal: document.getElementById('fpsVal')
        };

        // Initialize
        if (!API_KEY) {
            els.apiKeyModal.classList.remove('hidden');
        } else {
            els.apiKeyModal.classList.add('hidden');
        }

        // ==========================================
        // ğŸ” API Key Handling
        // ==========================================
        function saveApiKey() {
            const key = els.apiKeyInput.value.trim();
            if (key.length < 10) {
                alert('× ×¨××” ×©×”××¤×ª×— ×§×¦×¨ ××“×™, ×‘×“×•×§ ×©×•×‘.');
                return;
            }
            localStorage.setItem('GEMINI_API_KEY', key);
            API_KEY = key;
            els.apiKeyModal.classList.add('hidden');
            location.reload(); // Refresh to clean state
        }

        function changeApiKey() {
            els.apiKeyInput.value = '';
            els.apiKeyModal.classList.remove('hidden');
        }

        // ==========================================
        // ğŸ¤– Gemini Image Generation
        // ==========================================
        async function startGeneration() {
            const prompt = els.promptInput.value.trim();
            const count = parseInt(els.framesCount.value);
            const style = els.styleInput.value.trim();

            if (!prompt) {
                showStatus(els.genStatus, '×× × ×”×–×Ÿ ×ª×™××•×¨ ×œ×ª××•× ×”', 'error');
                return;
            }

            // UI Reset
            els.generateBtn.disabled = true;
            els.generateBtn.innerHTML = '×˜×•×¢×Ÿ... <div class="loader"></div>';
            els.framesList.innerHTML = '';
            frames = [];
            
            // ×× ×—× ×• ××™×™×¦×¨×™× ×¤×¨×•××¤×˜×™× ×¢× ×©×™× ×•×™×™× ×§×œ×™× ×›×“×™ ×œ×§×‘×œ ×ª× ×•×¢×”
            // ××• ×©×•×œ×—×™× ×‘×§×©×•×ª × ×¤×¨×“×•×ª ×›×“×™ ×œ×§×‘×œ ×•×¨×™××¦×™×•×ª ×©×œ ××•×ª×• ×¡×™×“
            // ×‘×’×¨×¡×ª ×”×“×¤×“×¤×Ÿ ×”×–×•, × ×©×œ×— ×‘×§×©×•×ª ×¡×“×¨×ª×™×•×ª ×¢× ×”× ×—×™×” ×œ×©×™× ×•×™ ×–×•×•×™×ª ××–×¢×¨×™
            
            try {
                showStatus(els.genStatus, `××ª×—×™×œ ×™×¦×™×¨×” ×©×œ ${count} ×ª××•× ×•×ª...`);

                // Create slight variations in prompt for better GIF movement illusion
                // Gemini doesn't support "seed" control perfectly via REST API for identical consistency yet,
                // so we ask for slight variations in the prompt.
                const basePrompt = style ? `${style} style. ${prompt}` : prompt;

                // ×× ×• × ×©×ª××© ×‘××•×“×œ Imagen 3 (×× ×–××™×Ÿ) ××• 2.
                // ×”×¢×¨×”: × ×›×•×Ÿ ×œ-2025, ×”×’×™×©×” ×œ-Imagen ×“×¨×š ×”-API ×”×¦×™×‘×•×¨×™ ×¢×©×•×™×” ×œ×”×©×ª× ×•×ª.
                // ×”×§×•×“ ××©×ª××© ×‘-Endpoint ×”×¡×˜× ×“×¨×˜×™ ×©×œ Gemini ×œ×™×¦×™×¨×ª ×ª××•× ×•×ª (beta).
                
                const imagePromises = [];
                for(let i=0; i<count; i++) {
                    // ××•×¡×™×¤×™× ×•×¨×™××¦×™×” ×§×œ×” ×œ×¤×¨×•××¤×˜ ×›×“×™ ×œ×§×‘×œ '×ª× ×•×¢×”' ××• ×¡×“×¨×”
                    const varPrompt = `${basePrompt}. Variation ${i+1}, slightly different angle or pose, consistent lighting.`;
                    imagePromises.push(generateSingleImage(varPrompt, i));
                    // ×”×©×”×™×” ×§×˜× ×” ×œ×× ×™×¢×ª Rate Limit
                    await new Promise(r => setTimeout(r, 500)); 
                }

                await Promise.all(imagePromises);
                
                showStatus(els.genStatus, '×”×ª××•× ×•×ª × ×•×¦×¨×• ×‘×”×¦×œ×—×”!', 'success');
                els.createGifBtn.disabled = false;

            } catch (error) {
                console.error(error);
                showStatus(els.genStatus, `×©×’×™××”: ${error.message}`, 'error');
            } finally {
                els.generateBtn.disabled = false;
                els.generateBtn.innerHTML = 'ğŸ¨ ×¦×•×¨ ×ª××•× ×•×ª';
            }
        }

        async function generateSingleImage(prompt, index) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${API_KEY}`;
            
            // ××‘× ×” ×‘×§×©×” ×œ-Imagen ×“×¨×š ×”-REST API
            // ×©×™× ×œ×‘: ×”××‘× ×” ×¢×©×•×™ ×œ×”×©×ª× ×•×ª, ×–×” ×”××‘× ×” ×”×¢×“×›× ×™ ×œ×’×¨×¡××•×ª ×‘×˜×
            const payload = {
                instances: [
                    { prompt: prompt }
                ],
                parameters: {
                    sampleCount: 1,
                    aspectRatio: "1:1"
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || 'API request failed');
                }

                const data = await response.json();
                
                // Parsing image data (Base64)
                // ×”××‘× ×” ×©×œ Imagen ××—×–×™×¨ ×‘×“×¨×š ×›×œ×œ predictions[0].bytesBase64Encoded ××• ×“×•××”
                let b64 = null;
                
                if (data.predictions && data.predictions[0] && data.predictions[0].bytesBase64Encoded) {
                    b64 = data.predictions[0].bytesBase64Encoded;
                } else if (data.predictions && data.predictions[0] && data.predictions[0].b64) {
                     b64 = data.predictions[0].b64;
                } else {
                     // Fallback check for different structure
                     console.log('Unknown response structure', data);
                     throw new Error('××‘× ×” ×ª×©×•×‘×” ×œ× ××–×•×”×” ××”-API');
                }

                const imgSrc = `data:image/png;base64,${b64}`;
                addFrameToUI(imgSrc, index);
                frames.push({ src: imgSrc, id: Date.now() + index });

            } catch (e) {
                throw e;
            }
        }

        // ==========================================
        // ğŸ–¼ï¸ UI & Frames Management
        // ==========================================
        function addFrameToUI(src, index) {
            const div = document.createElement('div');
            div.className = 'frame-card';
            div.draggable = true;
            div.dataset.index = index;
            
            div.innerHTML = `
                <img src="${src}" alt="Frame">
                <button class="delete-btn" onclick="removeFrame(this)">Ã—</button>
                <span class="frame-number">${document.querySelectorAll('.frame-card').length + 1}</span>
            `;

            // Drag and Drop Logic
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', handleDragEnd);

            els.framesList.appendChild(div);
            updateFrameNumbers();
        }

        function removeFrame(btn) {
            const card = btn.parentElement;
            card.remove();
            updateFrameNumbers();
            // ×× ××™×Ÿ ×¤×¨×™×™××™×, ××©×‘×™×ª×™× ×›×¤×ª×•×¨ GIF
            if (document.querySelectorAll('.frame-card').length < 2) {
                els.createGifBtn.disabled = true;
            }
        }

        function updateFrameNumbers() {
            const cards = document.querySelectorAll('.frame-card');
            cards.forEach((card, idx) => {
                card.querySelector('.frame-number').innerText = idx + 1;
            });
            // Update internal frames array order based on DOM
            // (We rebuild the frames array during GIF generation based on DOM order)
        }

        // --- Drag & Drop Handlers ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                // Swap elements
                const list = els.framesList;
                const allItems = [...list.children];
                const fromIndex = allItems.indexOf(dragSrcEl);
                const toIndex = allItems.indexOf(this);

                if (fromIndex < toIndex) {
                    this.after(dragSrcEl);
                } else {
                    this.before(dragSrcEl);
                }
                updateFrameNumbers();
            }
            return false;
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
        }

        // ==========================================
        // ğŸï¸ GIF Generation Logic (Client Side)
        // ==========================================
        function updateFPS(val) {
            els.fpsVal.innerText = val;
        }

        async function renderGIF() {
            // ××•×¡×¤×™× ××ª ×”×ª××•× ×•×ª ×œ×¤×™ ×”×¡×“×¨ ×”× ×•×›×—×™ ×‘-DOM
            const cards = document.querySelectorAll('.frame-card img');
            if (cards.length === 0) return;

            els.createGifBtn.disabled = true;
            els.gifProgress.style.width = '0%';
            showStatus(els.gifStatus, '××›×™×Ÿ GIF...');

            // ×”×’×“×¨×ª GIF.js
            // ×”×¢×¨×” ×—×©×•×‘×”: gif.worker.js ×—×™×™×‘ ×œ×”×™×•×ª × ×’×™×©.
            // ××›×™×•×•×Ÿ ×©×× ×—× ×• ×‘×§×•×‘×¥ ×™×—×™×“, × ×©×ª××© ×‘×˜×¨×™×§ ×©×œ Blob URL ×œ-Worker
            
            const workerBlob = new Blob([`
                importScripts('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
            `], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);

            const gif = new GIF({
                workers: 2,
                quality: 10,
                workerScript: workerUrl,
                width: 512, // Default size
                height: 512
            });

            // Loading images into Canvas and adding to GIF
            const fps = parseInt(els.fpsInput.value);
            const delay = 1000 / fps;

            showStatus(els.gifStatus, '××¢×‘×“ ×¤×¨×™×™××™×...');
            
            let loadedCount = 0;
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            tempCanvas.width = 512;
            tempCanvas.height = 512;

            for (let imgEl of cards) {
                // ×¦×¨×™×š ×œ×”××™×¨ ×—×–×¨×” ×œ-Image Object × ×§×™ ×›×“×™ ×œ×¦×™×™×¨ ×‘-Canvas
                await new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, 512, 512);
                        gif.addFrame(ctx, {copy: true, delay: delay});
                        resolve();
                    };
                    img.src = imgEl.src;
                });
                loadedCount++;
                els.gifProgress.style.width = `${(loadedCount / cards.length) * 40}%`;
            }

            gif.on('progress', (p) => {
                els.gifProgress.style.width = `${40 + (p * 60)}%`;
                showStatus(els.gifStatus, `××¨× ×“×¨: ${Math.round(p * 100)}%`);
            });

            gif.on('finished', (blob) => {
                const url = URL.createObjectURL(blob);
                els.gifPreview.src = url;
                
                // ×”×›× ×ª ×›×¤×ª×•×¨ ×”×•×¨×“×”
                const a = document.getElementById('downloadLink');
                a.href = url;
                a.download = `gemini-gif-${Date.now()}.gif`;
                
                // ×©×™× ×•×™ ×”×›×¤×ª×•×¨ ×œ×”×•×¨×“×”
                els.createGifBtn.innerText = 'ğŸ“¥ ×”×•×¨×“ GIF';
                els.createGifBtn.onclick = () => a.click();
                els.createGifBtn.disabled = false;
                
                showStatus(els.gifStatus, '×”-GIF ××•×›×Ÿ!', 'success');
            });

            gif.render();
        }

        // ==========================================
        // ğŸ”§ Utilities
        // ==========================================
        function showStatus(element, msg, type = 'normal') {
            element.innerText = msg;
            element.className = 'status-msg';
            if (type === 'error') element.classList.add('status-error');
            if (type === 'success') element.classList.add('status-success');
        }

    </script>
</body>
</html>
